000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. GENTRAN.
000300 AUTHOR. VSAM TRANSACTION GENERATOR.
000400*
000500* PURPOSE: GENERATE TRANSACTIONS WITH SEQUENTIAL INTEGER KEYS
000600* CLEARS ALL EXISTING TRANSACTIONS FIRST
000700* USES PROPER COMP KEYS FOR VSAM SORTING
000800*
000900 ENVIRONMENT DIVISION.
001000 INPUT-OUTPUT SECTION.
001100 FILE-CONTROL.
001200     SELECT ACCOUNT-FILE ASSIGN TO CUSTFILE
001300         ORGANIZATION IS INDEXED
001400         ACCESS MODE IS RANDOM
001500         RECORD KEY IS CUST-KEY
001600         FILE STATUS IS WS-ACCT-STATUS.
001700     SELECT TRANSACTION-OUT ASSIGN TO TRANOUT
001800         ORGANIZATION IS INDEXED
001900         ACCESS MODE IS RANDOM
002000         RECORD KEY IS TXN-ID
002100         FILE STATUS IS WS-TXN-STATUS.
002200
002300 DATA DIVISION.
002400 FILE SECTION.
002500 FD  ACCOUNT-FILE
002600     RECORD CONTAINS 200 CHARACTERS.
002700 COPY CUSTCOPY.
002800
002900 FD  TRANSACTION-OUT
003000     RECORD CONTAINS 200 CHARACTERS.
003100 COPY TXNCOPY.
003200
003300 WORKING-STORAGE SECTION.
003400 01  WS-FILE-STATUS.
003500     05  WS-ACCT-STATUS          PIC XX.
003600     05  WS-TXN-STATUS           PIC XX.
003700
003800 01  WS-COUNTERS.
003900     05  WS-TRANSACTION-COUNT    PIC 9(5) VALUE ZERO.
004000     05  WS-MAX-TRANSACTIONS     PIC 9(5) VALUE 1000.
004100     05  WS-TXN-ID-COUNTER       PIC 9(9) VALUE ZERO.
004200     05  WS-TXN-ID-WORK          PIC 9(12) VALUE ZERO.
004300
004400 01  WS-RANDOM-WORK.
004500     05  WS-RANDOM-SEED          PIC 9(8).
004600     05  WS-RANDOM-NUM           PIC V9(10).
004700     05  WS-TRANSACTION-TYPE     PIC 9.
004800
004900 01  WS-ACCOUNT-WORK.
005000     05  WS-ACCOUNT-NUM          PIC 9.
005100     05  WS-FROM-ACCOUNT-KEY     PIC X(10) VALUE SPACES.
005200     05  WS-TO-ACCOUNT-KEY       PIC X(10) VALUE SPACES.
005300     05  WS-ACCOUNT-PADDED       PIC 9(10) VALUE ZERO.
005400
005500 01  WS-AMOUNT-WORK.
005600     05  WS-AMOUNT               PIC 9(5)V99.
005700
005800 01  WS-TIME-WORK.
005900     05  WS-CURRENT-DATE-TIME    PIC X(21).
006000     05  WS-CURRENT-DATE         PIC X(8).
006100     05  WS-CURRENT-TIME         PIC X(8).
006200
006300 01  WS-TRANSACTION-TYPES.
006400     05  FILLER                  PIC X(8) VALUE 'DEBIT   '.
006500     05  FILLER                  PIC X(8) VALUE 'CREDIT  '.
006600     05  FILLER                  PIC X(8) VALUE 'TRANSFER'.
006700     05  FILLER                  PIC X(8) VALUE 'INQUIRY '.
006800 01  WS-TRAN-TYPE-TABLE REDEFINES WS-TRANSACTION-TYPES.
006900     05  WS-TRAN-TYPE            PIC X(8) OCCURS 4.
007000
007100 PROCEDURE DIVISION.
007200 0000-MAIN-PROCESS.
007300     PERFORM 1000-INITIALIZE
007400     PERFORM 1500-PURGE-OLD-TRANSACTIONS
007500     PERFORM 2000-PROCESS-TRANSACTIONS
007600         UNTIL WS-TRANSACTION-COUNT >= WS-MAX-TRANSACTIONS
007700     PERFORM 9000-TERMINATE
007800     GOBACK.
007900
008000 1000-INITIALIZE.
008100     MOVE FUNCTION CURRENT-DATE TO WS-CURRENT-DATE-TIME
008200     MOVE WS-CURRENT-DATE-TIME(1:8) TO WS-CURRENT-DATE
008300     MOVE WS-CURRENT-DATE-TIME(9:6) TO WS-CURRENT-TIME
008400     MOVE WS-CURRENT-DATE-TIME(9:8) TO WS-RANDOM-SEED
008500     COMPUTE WS-RANDOM-NUM = FUNCTION RANDOM(WS-RANDOM-SEED)
008600     
008700     OPEN INPUT ACCOUNT-FILE
008800     IF WS-ACCT-STATUS NOT = '00'
008900         DISPLAY 'ERROR OPENING ACCOUNT-FILE: ' WS-ACCT-STATUS
009000         GOBACK
009100     END-IF
009200     DISPLAY 'INITIALIZED - STARTING TRANSACTION GENERATION'.
009300
009400 1500-PURGE-OLD-TRANSACTIONS.
009500     DISPLAY 'PURGING EXISTING TRANSACTIONS...'
009600     OPEN OUTPUT TRANSACTION-OUT
009700     IF WS-TXN-STATUS NOT = '00'
009800         DISPLAY 'ERROR OPENING TRANSACTION-OUT: ' WS-TXN-STATUS
009900         GOBACK
010000     END-IF
010100     DISPLAY 'TRANSACTION FILE READY FOR NEW RECORDS'.
010200
010300 2000-PROCESS-TRANSACTIONS.
010400     PERFORM 2100-GENERATE-TRANSACTION
010500     WRITE TXN-REC
010600     ADD 1 TO WS-TRANSACTION-COUNT
010700     IF WS-TXN-STATUS NOT = '00'
010800         DISPLAY 'ERROR WRITING TRANSACTION: ' WS-TXN-STATUS
010900         DISPLAY 'TXN-ID: ' TXN-ID
011000         DISPLAY 'FROM-ACCOUNT: ' FROM-ACCOUNT
011100     END-IF.
011200
011300 2100-GENERATE-TRANSACTION.
011400     PERFORM 2110-GENERATE-TXN-ID
011500     PERFORM 2120-SELECT-TRANSACTION-TYPE
011600     PERFORM 2130-GENERATE-ACCOUNTS
011700     PERFORM 2140-GENERATE-AMOUNT
011800     PERFORM 2150-SET-TIMESTAMPS
011900     MOVE 'PENDING ' TO TXN-STATUS
012000     MOVE 'GENERATED TRANSACTION' TO TXN-DESCRIPTION
012100     MOVE SPACES TO TXN-REFERENCE
012200     MOVE SPACES TO TXN-ERROR-CODE
012300     MOVE SPACES TO TXN-ERROR-MESSAGE.
012400
012500 2110-GENERATE-TXN-ID.
012600     ADD 1 TO WS-TXN-ID-COUNTER
012700     MOVE WS-TXN-ID-COUNTER TO WS-TXN-ID-WORK
012800     MOVE WS-TXN-ID-WORK TO TXN-ID.
012900
013000 2120-SELECT-TRANSACTION-TYPE.
013100     COMPUTE WS-RANDOM-NUM = FUNCTION RANDOM
013200     COMPUTE WS-TRANSACTION-TYPE = (WS-RANDOM-NUM * 4) + 1
013300     IF WS-TRANSACTION-TYPE > 4 OR WS-TRANSACTION-TYPE < 1
013400         MOVE 1 TO WS-TRANSACTION-TYPE
013500     END-IF
013600     MOVE WS-TRAN-TYPE(WS-TRANSACTION-TYPE) TO TXN-TYPE.
013700
013800 2130-GENERATE-ACCOUNTS.
013900     COMPUTE WS-RANDOM-NUM = FUNCTION RANDOM
014000     COMPUTE WS-ACCOUNT-NUM = (WS-RANDOM-NUM * 5) + 1
014100     IF WS-ACCOUNT-NUM > 5 OR WS-ACCOUNT-NUM < 1
014200         MOVE 1 TO WS-ACCOUNT-NUM
014300     END-IF
014400*    DEBUG: SHOW ACCOUNT NUMBER GENERATION
014500     DISPLAY 'DEBUG: WS-ACCOUNT-NUM = ' WS-ACCOUNT-NUM
014600*    BUILD ACCOUNT KEY USING DIRECT MOVE OPERATIONS
014700     MOVE SPACES TO WS-FROM-ACCOUNT-KEY
014800     MOVE '0000' TO WS-FROM-ACCOUNT-KEY(1:4)
014900     MOVE WS-ACCOUNT-NUM TO WS-FROM-ACCOUNT-KEY(5:1)
015000     DISPLAY 'DEBUG: FROM-ACCOUNT = ''' WS-FROM-ACCOUNT-KEY ''''
015100     MOVE WS-FROM-ACCOUNT-KEY TO FROM-ACCOUNT
015100     
015200     IF TXN-TRANSFER
015300         COMPUTE WS-ACCOUNT-NUM = (FUNCTION RANDOM * 5) + 1
015400         IF WS-ACCOUNT-NUM > 5 OR WS-ACCOUNT-NUM < 1 
015500             MOVE 2 TO WS-ACCOUNT-NUM
015600         END-IF
015700*        ENSURE TO-ACCOUNT DIFFERENT FROM FROM-ACCOUNT
015800         MOVE WS-FROM-ACCOUNT-KEY(5:1) TO WS-FROM-ACCOUNT-KEY(10:1)
015900         IF WS-ACCOUNT-NUM = WS-FROM-ACCOUNT-KEY(10:1)
016000             IF WS-ACCOUNT-NUM = 5
016100                 MOVE 1 TO WS-ACCOUNT-NUM
016200             ELSE
016300                 ADD 1 TO WS-ACCOUNT-NUM
016400             END-IF
016500         END-IF
016600         DISPLAY 'DEBUG: TO WS-ACCOUNT-NUM = ' WS-ACCOUNT-NUM
016700*        BUILD TO-ACCOUNT KEY USING DIRECT MOVE OPERATIONS  
016800         MOVE SPACES TO WS-TO-ACCOUNT-KEY
016900         MOVE '0000' TO WS-TO-ACCOUNT-KEY(1:4)
017000         MOVE WS-ACCOUNT-NUM TO WS-TO-ACCOUNT-KEY(5:1)
017100         DISPLAY 'DEBUG: TO-ACCOUNT = ''' WS-TO-ACCOUNT-KEY ''''
017200         MOVE WS-TO-ACCOUNT-KEY TO TO-ACCOUNT
017200     ELSE
017300         MOVE SPACES TO TO-ACCOUNT
017400     END-IF.
017500
017600 2140-GENERATE-AMOUNT.
017700     COMPUTE WS-RANDOM-NUM = FUNCTION RANDOM
017800     COMPUTE WS-AMOUNT = (WS-RANDOM-NUM * 1000) + 1
017900     MOVE WS-AMOUNT TO TXN-AMOUNT.
018000
018100 2150-SET-TIMESTAMPS.
018200     MOVE WS-CURRENT-DATE TO TXN-DATE
018300     MOVE WS-CURRENT-DATE TO TXN-CREATED-DATE
018400     MOVE WS-CURRENT-TIME TO TXN-TIME
018500     MOVE WS-CURRENT-TIME TO TXN-CREATED-TIME
018600     MOVE SPACES TO TXN-PROCESSED-DATE
018700     MOVE SPACES TO TXN-PROCESSED-TIME
018800*    DEBUG: SHOW COMPLETED TRANSACTION
018900     DISPLAY 'DEBUG: TXN=' TXN-ID ' TYPE=' TXN-TYPE
019000             ' FROM=' FROM-ACCOUNT ' TO=' TO-ACCOUNT.
019100
019200 9000-TERMINATE.
019300     CLOSE ACCOUNT-FILE
019400     CLOSE TRANSACTION-OUT
019500     DISPLAY 'TRANSACTION GENERATION COMPLETE'
019600     DISPLAY 'TRANSACTIONS GENERATED: ' WS-TRANSACTION-COUNT
019700     DISPLAY 'TARGET COUNT WAS: ' WS-MAX-TRANSACTIONS.