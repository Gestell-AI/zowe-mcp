000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. PROCTXN.
000300 AUTHOR. TRANSACTION PROCESSING SYSTEM.
000400 DATE-WRITTEN. 2025.
000500*
000600* PURPOSE: PROCESS PENDING TRANSACTIONS WITH PROPER BALANCE HANDLING
000700* IMPLEMENTS ATOMIC READ-UPDATE-REWRITE PATTERN FOR DATA INTEGRITY
000800* HANDLES TRANSFER, CREDIT, DEBIT, AND INQUIRY OPERATIONS
000900*
001000 ENVIRONMENT DIVISION.
001100 INPUT-OUTPUT SECTION.
001200 FILE-CONTROL.
001300     SELECT TXN-FILE ASSIGN TO TXNDATA
001400         ORGANIZATION IS INDEXED
001500         ACCESS MODE IS DYNAMIC
001600         RECORD KEY IS TXN-ID
001700         FILE STATUS IS WS-TXN-STATUS.
001800
001900     SELECT ACCOUNT-FILE ASSIGN TO CUSTFILE
002000         ORGANIZATION IS INDEXED
002100         ACCESS MODE IS RANDOM
002200         RECORD KEY IS CUST-KEY
002300         FILE STATUS IS WS-ACCT-STATUS.
002400
002500     SELECT REPORT-FILE ASSIGN TO TXNRPT
002600         ORGANIZATION IS SEQUENTIAL
002700         FILE STATUS IS WS-REPORT-STATUS.
002800
002900 DATA DIVISION.
003000 FILE SECTION.
003100
003200 FD  TXN-FILE
003300     RECORD CONTAINS 200 CHARACTERS.
003400 COPY TXNCOPY.
003500
003600 FD  ACCOUNT-FILE
003700     RECORD CONTAINS 200 CHARACTERS.
003800 COPY CUSTCOPY.
003900
004000 FD  REPORT-FILE.
004100 01  REPORT-RECORD               PIC X(132).
004200
004300 WORKING-STORAGE SECTION.
004400
004500 01  WS-FILE-STATUS.
004600     05  WS-TXN-STATUS           PIC X(2).
004700     05  WS-ACCT-STATUS          PIC X(2).
004800     05  WS-REPORT-STATUS        PIC X(2).
004900
005000 01  WS-FLAGS.
005100     05  WS-EOF-FLAG             PIC X VALUE 'N'.
005200     05  WS-ERROR-FLAG           PIC X VALUE 'N'.
005300
005400 01  WS-COUNTERS.
005500     05  WS-TXN-PROCESSED        PIC 9(7) VALUE ZERO.
005600     05  WS-TXN-FAILED           PIC 9(7) VALUE ZERO.
005700     05  WS-TRANSFERS            PIC 9(7) VALUE ZERO.
005800     05  WS-DEPOSITS             PIC 9(7) VALUE ZERO.
005900     05  WS-WITHDRAWALS          PIC 9(7) VALUE ZERO.
006000     05  WS-INQUIRIES            PIC 9(7) VALUE ZERO.
006100
006200 01  WS-WORK-FIELDS.
006300     05  WS-CURRENT-DATE         PIC X(8).
006400     05  WS-CURRENT-TIME         PIC X(8).
006500     05  WS-ERROR-MSG            PIC X(80).
006600
006700 01  WS-ACCOUNT-WORK.
006800     05  WS-FROM-ACCOUNT-KEY     PIC X(10).
006900     05  WS-TO-ACCOUNT-KEY       PIC X(10).
007000     05  WS-FROM-BALANCE         PIC S9(7)V99 COMP-3.
007100     05  WS-TO-BALANCE           PIC S9(7)V99 COMP-3.
007200     05  WS-NEW-BALANCE          PIC S9(7)V99 COMP-3.
007300
007400 01  WS-REPORT-WORK.
007500     05  WS-RPT-DATE             PIC X(8).
007600     05  WS-RPT-TXN-ID           PIC X(12).
007700     05  WS-RPT-TXN-TYPE         PIC X(8).
007800     05  WS-RPT-STATUS           PIC X(8).
007900     05  WS-RPT-AMOUNT           PIC Z,ZZZ,ZZ9.99.
008000
008100 01  WS-HEADER-1                 PIC X(132).
008200 01  WS-HEADER-2                 PIC X(132).
008300 01  WS-DETAIL-LINE              PIC X(132).
008400 01  WS-SUMMARY-LINE             PIC X(132).
008500
008600 PROCEDURE DIVISION.
008700
008800 0000-MAIN-PROCESS.
008900     PERFORM 1000-INITIALIZE
009000     PERFORM 2000-PROCESS-TRANSACTIONS
009100         UNTIL WS-EOF-FLAG = 'Y' OR WS-ERROR-FLAG = 'Y'
009200     PERFORM 3000-WRITE-SUMMARY
009300     PERFORM 9000-CLEANUP
009400     GOBACK.
009500
009600 1000-INITIALIZE.
009700     MOVE FUNCTION CURRENT-DATE(1:8) TO WS-CURRENT-DATE
009800     MOVE FUNCTION CURRENT-DATE(9:6) TO WS-CURRENT-TIME
009900     
010000     OPEN INPUT TXN-FILE
010100          I-O ACCOUNT-FILE
010200          OUTPUT REPORT-FILE
010300     
010400     IF WS-TXN-STATUS NOT = '00'
010500         DISPLAY 'ERROR OPENING TXN FILE: ' WS-TXN-STATUS
010600         MOVE 'Y' TO WS-ERROR-FLAG
010700     END-IF
010800     
010900     IF WS-ACCT-STATUS NOT = '00'
011000         DISPLAY 'ERROR OPENING ACCOUNT FILE: ' WS-ACCT-STATUS
011100         MOVE 'Y' TO WS-ERROR-FLAG
011200     END-IF
011300     
011400     IF WS-REPORT-STATUS NOT = '00'
011500         DISPLAY 'ERROR OPENING REPORT FILE: ' WS-REPORT-STATUS
011600         MOVE 'Y' TO WS-ERROR-FLAG
011700     END-IF
011800     
011900     MOVE WS-CURRENT-DATE TO WS-RPT-DATE
012000     
012100     MOVE SPACES TO WS-HEADER-1
012200     STRING 'TRANSACTION PROCESSING REPORT - DATE: ' 
012300            DELIMITED BY SIZE
012400            WS-RPT-DATE DELIMITED BY SIZE
012500            INTO WS-HEADER-1
012600     END-STRING
012700     
012800     MOVE ALL '=' TO WS-HEADER-2
012900     
013000     WRITE REPORT-RECORD FROM WS-HEADER-1
013100     WRITE REPORT-RECORD FROM WS-HEADER-2
013200     
013300     PERFORM 1100-READ-TRANSACTION.
013400
013500 1100-READ-TRANSACTION.
013600     READ TXN-FILE NEXT RECORD
013700         AT END MOVE 'Y' TO WS-EOF-FLAG
013800     END-READ
013900     
014000     IF WS-TXN-STATUS NOT = '00' AND WS-TXN-STATUS NOT = '10'
014100         DISPLAY 'ERROR READING TXN FILE: ' WS-TXN-STATUS
014200         MOVE 'Y' TO WS-ERROR-FLAG
014300     END-IF.
014400
014500 2000-PROCESS-TRANSACTIONS.
014600     IF WS-EOF-FLAG = 'Y' OR WS-ERROR-FLAG = 'Y'
014700         EXIT PARAGRAPH
014800     END-IF
014900     
015000     MOVE SPACES TO WS-ERROR-MSG
015100*    DEBUG: SHOW TRANSACTION DETAILS READ FROM FILE
015200     DISPLAY 'DEBUG: PROCESSING TXN=' TXN-ID ' TYPE=' TXN-TYPE
015300             ' FROM=''' FROM-ACCOUNT ''' TO=''' TO-ACCOUNT ''''
015400     
015500     EVALUATE TRUE
015600         WHEN TXN-TRANSFER
015700             PERFORM 2100-PROCESS-TRANSFER
015800         WHEN TXN-CREDIT
015900             PERFORM 2200-PROCESS-CREDIT  
016000         WHEN TXN-DEBIT
016100             PERFORM 2300-PROCESS-DEBIT
016200         WHEN TXN-INQUIRY
016300             PERFORM 2400-PROCESS-INQUIRY
016400         WHEN OTHER
016500             PERFORM 2900-INVALID-TRANSACTION
016600     END-EVALUATE
016700     
016800     PERFORM 2800-WRITE-DETAIL-LINE
016900     PERFORM 1100-READ-TRANSACTION.
017000
017100 2100-PROCESS-TRANSFER.
017200     ADD 1 TO WS-TRANSFERS
017300     
017400     MOVE FROM-ACCOUNT TO WS-FROM-ACCOUNT-KEY
017500*    ENSURE CLEAN ACCOUNT KEY FOR LOOKUP
017600     MOVE SPACES TO CUST-KEY
017700     MOVE WS-FROM-ACCOUNT-KEY TO CUST-KEY
017800     DISPLAY 'DEBUG: FROM-CUST-KEY SET TO = ''' CUST-KEY ''''
017900     PERFORM 2500-READ-ACCOUNT-FOR-UPDATE
018000     
018100     IF WS-ACCT-STATUS = '00'
018200         MOVE CUST-ACCT-BALANCE TO WS-FROM-BALANCE
018300         
018400         IF WS-FROM-BALANCE >= TXN-AMOUNT
018500             COMPUTE WS-NEW-BALANCE = WS-FROM-BALANCE - TXN-AMOUNT
018600             MOVE WS-NEW-BALANCE TO CUST-ACCT-BALANCE
018700             PERFORM 2700-UPDATE-ACCOUNT
018800             
018900             IF WS-ACCT-STATUS = '00'
019000                 MOVE TO-ACCOUNT TO WS-TO-ACCOUNT-KEY
019100*                ENSURE CLEAN TO-ACCOUNT KEY FOR LOOKUP
019200                 MOVE SPACES TO CUST-KEY
019300                 MOVE WS-TO-ACCOUNT-KEY TO CUST-KEY
019400                 DISPLAY 'DEBUG: TO-CUST-KEY SET TO = ''' CUST-KEY ''''
019500                 PERFORM 2500-READ-ACCOUNT-FOR-UPDATE
019600                 
019700                 IF WS-ACCT-STATUS = '00'
019800                     MOVE CUST-ACCT-BALANCE TO WS-TO-BALANCE
019900                     COMPUTE WS-NEW-BALANCE = 
020000                         WS-TO-BALANCE + TXN-AMOUNT
020100                     MOVE WS-NEW-BALANCE TO CUST-ACCT-BALANCE
020200                     PERFORM 2700-UPDATE-ACCOUNT
020300                     
020400                     IF WS-ACCT-STATUS = '00'
020500                         MOVE 'COMPLETE' TO TXN-STATUS
020600                         ADD 1 TO WS-TXN-PROCESSED
020700                     ELSE
020800                         MOVE 'FAILED  ' TO TXN-STATUS
020900                         MOVE 'TO-ACCOUNT UPDATE FAILED' 
021000                              TO WS-ERROR-MSG
021100                         ADD 1 TO WS-TXN-FAILED
021200                     END-IF
021300                 ELSE
021400                     MOVE 'FAILED  ' TO TXN-STATUS
021500                     MOVE 'TO-ACCOUNT NOT FOUND' TO WS-ERROR-MSG
021600                     ADD 1 TO WS-TXN-FAILED
021700                 END-IF
021800             ELSE
021900                 MOVE 'FAILED  ' TO TXN-STATUS
022000                 MOVE 'FROM-ACCOUNT UPDATE FAILED' TO WS-ERROR-MSG
022100                 ADD 1 TO WS-TXN-FAILED
022200             END-IF
022300         ELSE
022400             MOVE 'FAILED  ' TO TXN-STATUS
022500             MOVE 'INSUFFICIENT FUNDS' TO WS-ERROR-MSG
022600             ADD 1 TO WS-TXN-FAILED
022700         END-IF
022800     ELSE
022900         MOVE 'FAILED  ' TO TXN-STATUS
023000         MOVE 'FROM-ACCOUNT NOT FOUND' TO WS-ERROR-MSG
023100         ADD 1 TO WS-TXN-FAILED
023200     END-IF.
023300
023400 2200-PROCESS-CREDIT.
023500     ADD 1 TO WS-DEPOSITS
023600     
023700     MOVE FROM-ACCOUNT TO WS-FROM-ACCOUNT-KEY
023800*    ENSURE CLEAN ACCOUNT KEY FOR LOOKUP  
023900     MOVE SPACES TO CUST-KEY
024000     MOVE WS-FROM-ACCOUNT-KEY TO CUST-KEY
024100     DISPLAY 'DEBUG: CREDIT-CUST-KEY SET TO = ''' CUST-KEY ''''
024200     PERFORM 2500-READ-ACCOUNT-FOR-UPDATE
024300     
024400     IF WS-ACCT-STATUS = '00'
024500         MOVE CUST-ACCT-BALANCE TO WS-FROM-BALANCE
024600         COMPUTE WS-NEW-BALANCE = WS-FROM-BALANCE + TXN-AMOUNT
024700         MOVE WS-NEW-BALANCE TO CUST-ACCT-BALANCE
024800         PERFORM 2700-UPDATE-ACCOUNT
024900         
025000         IF WS-ACCT-STATUS = '00'
025100             MOVE 'COMPLETE' TO TXN-STATUS
025200             ADD 1 TO WS-TXN-PROCESSED
025300         ELSE
025400             MOVE 'FAILED  ' TO TXN-STATUS
025500             MOVE 'ACCOUNT UPDATE FAILED' TO WS-ERROR-MSG
025600             ADD 1 TO WS-TXN-FAILED
025700         END-IF
025800     ELSE
025900         MOVE 'FAILED  ' TO TXN-STATUS
026000         MOVE 'ACCOUNT NOT FOUND' TO WS-ERROR-MSG
026100         ADD 1 TO WS-TXN-FAILED
026200     END-IF.
026300
026400 2300-PROCESS-DEBIT.
026500     ADD 1 TO WS-WITHDRAWALS
026600     
026700     MOVE FROM-ACCOUNT TO WS-FROM-ACCOUNT-KEY
026800*    ENSURE CLEAN ACCOUNT KEY FOR LOOKUP
026900     MOVE SPACES TO CUST-KEY
027000     MOVE WS-FROM-ACCOUNT-KEY TO CUST-KEY
027100     DISPLAY 'DEBUG: DEBIT-CUST-KEY SET TO = ''' CUST-KEY ''''
027200     PERFORM 2500-READ-ACCOUNT-FOR-UPDATE
027300     
027400     IF WS-ACCT-STATUS = '00'
027500         MOVE CUST-ACCT-BALANCE TO WS-FROM-BALANCE
027600         
027700         IF WS-FROM-BALANCE >= TXN-AMOUNT
027800             COMPUTE WS-NEW-BALANCE = WS-FROM-BALANCE - TXN-AMOUNT
027900             MOVE WS-NEW-BALANCE TO CUST-ACCT-BALANCE
028000             PERFORM 2700-UPDATE-ACCOUNT
028100             
028200             IF WS-ACCT-STATUS = '00'
028300                 MOVE 'COMPLETE' TO TXN-STATUS
028400                 ADD 1 TO WS-TXN-PROCESSED
028500             ELSE
028600                 MOVE 'FAILED  ' TO TXN-STATUS
028700                 MOVE 'ACCOUNT UPDATE FAILED' TO WS-ERROR-MSG
028800                 ADD 1 TO WS-TXN-FAILED
028900             END-IF
029000         ELSE
029100             MOVE 'FAILED  ' TO TXN-STATUS
029200             MOVE 'INSUFFICIENT FUNDS' TO WS-ERROR-MSG
029300             ADD 1 TO WS-TXN-FAILED
029400         END-IF
029500     ELSE
029600         MOVE 'FAILED  ' TO TXN-STATUS
029700         MOVE 'ACCOUNT NOT FOUND' TO WS-ERROR-MSG
029800         ADD 1 TO WS-TXN-FAILED
029900     END-IF.
030000
030100 2400-PROCESS-INQUIRY.
030200     ADD 1 TO WS-INQUIRIES
030300     
030400     MOVE FROM-ACCOUNT TO WS-FROM-ACCOUNT-KEY
030500*    ENSURE CLEAN ACCOUNT KEY FOR LOOKUP
030600     MOVE SPACES TO CUST-KEY
030700     MOVE WS-FROM-ACCOUNT-KEY TO CUST-KEY
030800     DISPLAY 'DEBUG: INQUIRY-CUST-KEY SET TO = ''' CUST-KEY ''''
030900     PERFORM 2600-READ-ACCOUNT
031000     
031100     IF WS-ACCT-STATUS = '00'
031200         MOVE 'COMPLETE' TO TXN-STATUS
031300         ADD 1 TO WS-TXN-PROCESSED
031400     ELSE
031500         MOVE 'FAILED  ' TO TXN-STATUS
031600         MOVE 'ACCOUNT NOT FOUND' TO WS-ERROR-MSG
031700         ADD 1 TO WS-TXN-FAILED
031800     END-IF.
031900
032000 2500-READ-ACCOUNT-FOR-UPDATE.
032100     DISPLAY 'DEBUG: SEARCHING FOR ACCOUNT KEY = ''' CUST-KEY ''''
032200     READ ACCOUNT-FILE
032300         INVALID KEY
032400             DISPLAY 'DEBUG: ACCOUNT KEY NOT FOUND = ''' CUST-KEY ''''
032500             MOVE '23' TO WS-ACCT-STATUS
032600     END-READ.
032700
032800 2600-READ-ACCOUNT.
032900     DISPLAY 'DEBUG: SEARCHING FOR ACCOUNT KEY = ''' CUST-KEY ''''
033000     READ ACCOUNT-FILE
033100         INVALID KEY
033200             DISPLAY 'DEBUG: ACCOUNT KEY NOT FOUND = ''' CUST-KEY ''''
033300             MOVE '23' TO WS-ACCT-STATUS
033400     END-READ.
033500
033600 2700-UPDATE-ACCOUNT.
033700     REWRITE CUST-REC
033800         INVALID KEY
033900             DISPLAY 'ERROR UPDATING ACCOUNT: ' CUST-KEY
034000             MOVE 'FAILED  ' TO TXN-STATUS
034100             MOVE 'REWRITE ERROR' TO WS-ERROR-MSG
034200             ADD 1 TO WS-TXN-FAILED
034300             SUBTRACT 1 FROM WS-TXN-PROCESSED
034400     END-REWRITE.
034500
034600 2800-WRITE-DETAIL-LINE.
034700     MOVE SPACES TO WS-DETAIL-LINE
034800     MOVE TXN-ID TO WS-RPT-TXN-ID
034900     MOVE TXN-TYPE TO WS-RPT-TXN-TYPE
035000     MOVE TXN-STATUS TO WS-RPT-STATUS
035100     MOVE TXN-AMOUNT TO WS-RPT-AMOUNT
035200     
035300     STRING 'TXN ID: ' DELIMITED BY SIZE
035400            WS-RPT-TXN-ID DELIMITED BY SIZE
035500            ' TYPE: ' DELIMITED BY SIZE
035600            WS-RPT-TXN-TYPE DELIMITED BY SIZE
035700            ' AMOUNT: ' DELIMITED BY SIZE
035800            WS-RPT-AMOUNT DELIMITED BY SIZE
035900            ' STATUS: ' DELIMITED BY SIZE
036000            WS-RPT-STATUS DELIMITED BY SIZE
036100            INTO WS-DETAIL-LINE
036200     END-STRING
036300     
036400     WRITE REPORT-RECORD FROM WS-DETAIL-LINE
036500     
036600     IF WS-ERROR-MSG NOT = SPACES
036700         MOVE SPACES TO WS-DETAIL-LINE
036800         STRING '    ERROR: ' DELIMITED BY SIZE
036900                WS-ERROR-MSG DELIMITED BY SIZE
037000                INTO WS-DETAIL-LINE
037100         END-STRING
037200         WRITE REPORT-RECORD FROM WS-DETAIL-LINE
037300     END-IF
037400     
037500     MOVE SPACES TO WS-ERROR-MSG.
037600
037700 2900-INVALID-TRANSACTION.
037800     MOVE 'FAILED  ' TO TXN-STATUS
037900     MOVE 'INVALID TRANSACTION TYPE' TO WS-ERROR-MSG
038000     ADD 1 TO WS-TXN-FAILED.
038100
038200 3000-WRITE-SUMMARY.
038300     MOVE 'PROCESSING SUMMARY:' TO WS-SUMMARY-LINE
038400     WRITE REPORT-RECORD FROM WS-SUMMARY-LINE
038500     
038600     MOVE SPACES TO REPORT-RECORD
038700     STRING 'TOTAL PROCESSED: ' DELIMITED BY SIZE
038800            WS-TXN-PROCESSED DELIMITED BY SIZE
038900            INTO REPORT-RECORD
039000     END-STRING
039100     WRITE REPORT-RECORD
039200     
039300     MOVE SPACES TO REPORT-RECORD
039400     STRING 'TOTAL FAILED: ' DELIMITED BY SIZE
039500            WS-TXN-FAILED DELIMITED BY SIZE
039600            INTO REPORT-RECORD
039700     END-STRING
039800     WRITE REPORT-RECORD
039900     
040000     MOVE SPACES TO REPORT-RECORD
040100     STRING 'TRANSFERS: ' DELIMITED BY SIZE
040200            WS-TRANSFERS DELIMITED BY SIZE
040300            INTO REPORT-RECORD
040400     END-STRING
040500     WRITE REPORT-RECORD
040600     
040700     MOVE SPACES TO REPORT-RECORD
040800     STRING 'DEPOSITS: ' DELIMITED BY SIZE
040900            WS-DEPOSITS DELIMITED BY SIZE
041000            INTO REPORT-RECORD
041100     END-STRING
041200     WRITE REPORT-RECORD
041300     
041400     MOVE SPACES TO REPORT-RECORD
041500     STRING 'WITHDRAWALS: ' DELIMITED BY SIZE
041600            WS-WITHDRAWALS DELIMITED BY SIZE
041700            INTO REPORT-RECORD
041800     END-STRING
041900     WRITE REPORT-RECORD
042000     
042100     MOVE SPACES TO REPORT-RECORD
042200     STRING 'INQUIRIES: ' DELIMITED BY SIZE
042300            WS-INQUIRIES DELIMITED BY SIZE
042400            INTO REPORT-RECORD
042500     END-STRING
042600     WRITE REPORT-RECORD.
042700
042800 9000-CLEANUP.
042900     CLOSE TXN-FILE
043000           ACCOUNT-FILE
043100           REPORT-FILE.